<!doctype html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planning Policy Chat</title>


  <script
    async
    crossorigin="anonymous"
    data-clerk-publishable-key="pk_test_bm92ZWwtbWFybGluLTY3LmNsZXJrLmFjY291bnRzLmRldiQ"
    src="https://js.clerk.com/v4/clerk.browser.js">
  </script>



  <style>
    :root{
      --bg: #0b1220;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.09);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --border: rgba(255,255,255,.12);
      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --accent: #6ea8fe;
      --accent2:#8b5cf6;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(139,92,246,.22), transparent 60%),
        radial-gradient(1000px 700px at 80% 0%, rgba(110,168,254,.18), transparent 55%),
        radial-gradient(900px 700px at 50% 100%, rgba(34,197,94,.10), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px;
    }

    .shell{
      width:min(1080px, 100%);
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:18px;
    }

    @media (max-width: 980px){
      .shell{grid-template-columns: 1fr;}
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }

    .side{
      padding:18px 18px 14px 18px;
    }

    .brand{
      display:flex; align-items:center; gap:10px;
      padding: 16px 18px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    .logo {
      width: 34px;
      height: 34px;
      object-fit: contain;     /* ä¿è¯å›¾ç‰‡ä¸å˜å½¢ */
      border-radius: 10px;     /* åœ†è§’ï¼Œå¯è°ƒ */
      background: rgba(255,255,255,.08);
      background: linear-gradient(
      135deg,
      color-mix(in srgb, var(--accent) 60%, white),
      color-mix(in srgb, var(--accent2) 25%, white)
        );
      padding: 4px;            /* ç»™é€æ˜Ž PNG ç•™å‘¼å¸ç©ºé—´ */
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
    }


    .brand h1{
      font-size: 15px; margin:0; letter-spacing:.2px;
    }
    .brand p{
      margin:2px 0 0 0; font-size: 12px; color: var(--muted);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-size: 12px;
      margin: 10px 0 12px;
      user-select:none;
    }
    .dot{width:8px;height:8px;border-radius:50%; background: var(--good);}

    .help{
      padding: 0 18px 16px;
      border-top:1px solid var(--border);
    }
    .help h3{margin:14px 0 6px; font-size: 13px;}
    .help .hint{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.5;
    }
    .kbd{
      font-family: var(--mono);
      font-size: 11px;
      padding:2px 6px;
      border:1px solid var(--border);
      border-bottom-color: rgba(255,255,255,.20);
      border-radius: 7px;
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.85);
    }

    .main{
      display:flex;
      flex-direction:column;
      height: 78vh;
      min-height: 520px;
      max-height: 820px; /* âœ… å¯é€‰ï¼šå¤§å±åˆ«å¤ªé•¿ */
    }

    .toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 12px 14px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    .toolbar .title{
      display:flex; flex-direction:column;
    }
    .toolbar .title b{font-size: 13px;}
    .toolbar .title span{font-size: 12px; color: var(--muted); margin-top: 2px;}
    .toolbar .actions{display:flex; gap:8px;}
    button{
      appearance:none;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-size: 12px;
      transition: transform .06s ease, background .12s ease, border-color .12s ease;
    }
    button:hover{background: rgba(255,255,255,.09);}
    button:active{transform: translateY(1px);}
    button:disabled{
      opacity:.6;
      cursor:not-allowed;
    }

    .chat{
      padding: 16px 14px;
      flex: 1;
      min-height: 0;      /* âœ… å…³é”®ï¼šå…è®¸åœ¨ flex å®¹å™¨é‡Œæ»šåŠ¨ */
      overflow:auto;
      scroll-behavior:smooth;
    }

    .chat::-webkit-scrollbar {
      width: 10px;
    }
    .chat::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,.15);
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,0);
      background-clip: content-box;
    }
    .chat::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,.22);
      border: 2px solid rgba(0,0,0,0);
      background-clip: content-box;
    }

    .row{display:flex; gap:10px; margin: 10px 0;}
    .row.user{justify-content:flex-end;}
    .row.bot{justify-content:flex-start;}

    .bubble{
      max-width: min(720px, 92%);
      padding: 10px 12px;
      border-radius: 16px;
      border:1px solid var(--border);
      line-height: 1.55;
      font-size: 13.5px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .user .bubble{
      background: linear-gradient(135deg, rgba(110,168,254,.22), rgba(139,92,246,.18));
      border-color: rgba(110,168,254,.22);
    }
    .bot .bubble{
      background: rgba(255,255,255,.05);
    }

    .meta{
      font-size: 11px;
      color: var(--muted);
      margin-top: 6px;
    }

    .composer{
      padding: 12px;
      border-top:1px solid var(--border);
      display:flex;
      gap:10px;
      align-items:flex-end;
      background: rgba(0,0,0,.12);
    }

    textarea{
      flex:1;
      resize:none;
      height: 46px !important;
      min-height: 46px !important;
      max-height: 46px !important;

      overflow-y: auto !important;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--text);
      outline:none;
      font-size: 13px;
      line-height:1.4;
    }
    textarea:focus{border-color: rgba(110,168,254,.35);}

    .send{
      background: linear-gradient(135deg, rgba(110,168,254,.30), rgba(139,92,246,.22));
      border-color: rgba(110,168,254,.30);
      padding: 10px 12px;
      border-radius: 14px;
      min-width: 86px;
      font-weight: 600;
    }

    .status{
      padding: 10px 14px;
      font-size: 12px;
      color: var(--muted);
      border-top:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      gap:10px;
      background: rgba(255,255,255,.03);
    }
    .status .right{
      font-family: var(--mono);
      font-size: 11px;
      opacity:.9;
    }

    .toast{
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.16);
      color: rgba(255,255,255,.92);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 12px;
      box-shadow: 0 16px 50px rgba(0,0,0,.45);
      display:none;
      backdrop-filter: blur(10px);
    }

    /* ===== Markdown content styling ===== */
    /* Paragraphs */
    .bubble p {
      margin: 4px 0 2px;
    }

    /* Headings */
    .bubble h1 { margin: 10px 0 6px; font-size: 1.25em; }
    .bubble h2 { margin: 9px 0 5px; font-size: 1.15em; }
    .bubble h3 { margin: 8px 0 4px; font-size: 1.05em; }

    /* Lists */
    .bubble ul,
    .bubble ol {
      margin: 4px 0 6px;
      padding-left: 18px;
    }

    .bubble li {
      margin: 2px 0;
    }

    /* Prevent extra spacing between nested list items */
    .bubble li > ul,
    .bubble li > ol {
      margin-top: 2px;
      margin-bottom: 2px;
    }

    .bubble table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      font-size: 13px;
    }

    .bubble th, .bubble td {
      border: 1px solid var(--border);
      padding: 6px 8px;
      text-align: left;
    }

    .bubble th {
      background: rgba(255,255,255,.08);
    }

    .bubble code {
      font-family: var(--mono);
      background: rgba(0,0,0,.25);
      padding: 2px 5px;
      border-radius: 6px;
    }

    .bubble pre {
      background: rgba(0,0,0,.35);
      padding: 10px;
      border-radius: 12px;
      overflow-x: auto;
    }

    .bubble blockquote {
      border-left: 3px solid var(--accent);
      padding-left: 10px;
      color: var(--muted);
      margin: 8px 0;
    }


    /* ===== Welcome message spacing (tight) ===== */
    .bubble.welcome h3 {
      margin: 2px 0 5px;
    }

    .bubble.welcome p {
      margin: -40px 0 -55px;
    }

    .bubble.welcome ul {
      margin: 1px 0 -15px;
      padding-left: 25px;
    }

    .bubble.welcome li {
      margin: -18px 0;
    }

    .bubble.welcome .meta {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    /* ===== Link styling inside chat bubbles ===== */
    .bubble a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
      border-bottom: 1px dashed rgba(110,168,254,.45);
      transition: color .12s ease, border-color .12s ease, background .12s ease;
    }

    .bubble a:hover {
      color: #ffffff;
      border-bottom-color: rgba(110,168,254,.85);
      background: rgba(110,168,254,.12);
    }


  </style>
</head>

<body>
  <div class="shell">
    <!-- Sidebar -->
    <div class="card">
      <div class="brand">
        <img src="logo.png" class="logo" alt="Plannos logo" />
        <div>
          <h1>Plannos</h1>
          <p>AI-powered planning intelligence </p>
        </div>
      </div>

      <div class="side">
        <div class="pill"><span class="dot"></span> API connected (if URL is correct)</div>
        <div style="color:var(--muted); font-size:12px; line-height:1.55;">
          Use a <b>domain prefix</b> to route policy sources:
          <div class="meta" style="margin-top:8px">
            <span class="kbd">Westminster:</span> rear extension limits<br/>
            <span class="kbd">Global Policy:</span> overheating guidance<br/>
            <span class="kbd">Compare Camden vs Global Policy:</span> energy efficiency
          </div>
        </div>
      </div>

      <div class="help">
        <h3>Tips</h3>
        <div class="hint">
          â€¢ Press <span class="kbd">Enter</span> to send<br/>
          â€¢ <span class="kbd">Shift</span>+<span class="kbd">Enter</span> = new line<br/>
          â€¢ The bot cites sources as <span class="kbd">[1][2]</span> with a References section
        </div>
      </div>
    </div>

    <!-- Main -->
    <div class="card main">
      <div class="toolbar">
        <div class="title">
          <b>Chat</b>
          <span id="sub">Ready to answer planning policy questions</span>
        </div>
        <div class="actions">
          <button id="copyBtn" title="Copy last assistant message">Copy last</button>
          <button id="clearBtn" title="Clear chat">Clear</button>
        </div>
      </div>

      <div id="chat" class="chat"></div>

      <div class="composer">
        <textarea id="msg" placeholder="Type a messageâ€¦ e.g. â€˜Westminster: rear extension policy?â€™"></textarea>
        <button class="send" id="sendBtn">Send</button>
      </div>

      <div class="status">
        <div id="statusText">Ready</div>
      </div>
    </div>
  </div>

  <div id="authArea" style="display:flex; gap:8px; align-items:center;">
    <button id="signInBtn">Sign in</button>
    <button id="signUpBtn">Sign up</button>
    <div id="userBtn"></div>
  </div>

  <div id="signIn"></div>
  <div id="signUp"></div>


  <div class="toast" id="toast"></div>

  <script>
    marked.setOptions({
      breaks: true,        // æ¢è¡Œæ›´è‡ªç„¶
      gfm: true,           // GitHub é£Žæ ¼ Markdownï¼ˆè¡¨æ ¼å¿…éœ€ï¼‰
    });

    // 1) Set your backend base URL here (no trailing slash)
    // Example: https://plannos-realestate-kb-bot--fastapi-app.modal.run
    const API_BASE = "https://xchengcode--plannos-realestate-kb-bot-fastapi-app-dev.modal.run";

    const chatEl = document.getElementById("chat");
    const msgEl = document.getElementById("msg");
    const sendBtn = document.getElementById("sendBtn");
    const clearBtn = document.getElementById("clearBtn");
    const copyBtn = document.getElementById("copyBtn");
    const statusText = document.getElementById("statusText");
    const toastEl = document.getElementById("toast");

    let lastAssistantText = "";
    let isSending = false;

    function toast(text){
      toastEl.textContent = text;
      toastEl.style.display = "block";
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(()=> toastEl.style.display = "none", 1600);
    }

    function addMessage(role, text, { html = false, markdown = false } = {}) {
      const row = document.createElement("div");
      row.className = "row " + role;

      const bubble = document.createElement("div");
      bubble.className = "bubble";

      const raw = (text || "").trim();

      if (html) {
        bubble.innerHTML = raw;                // âœ… render HTML
      } else if (markdown) {
        bubble.innerHTML = marked.parse(raw);  // âœ… render Markdown
      } else {
        bubble.textContent = raw;              // âœ… plain text (safe for user)
      }

      row.appendChild(bubble);
      chatEl.appendChild(row);
      chatEl.scrollTop = chatEl.scrollHeight;
      return bubble;
    }

    function setSending(on){
      isSending = on;
      sendBtn.disabled = on;
      msgEl.disabled = on;
      statusText.textContent = on ? "Generatingâ€¦" : "Ready";
    }

    async function send(){
      const msg = msgEl.value.trim();
      if (!msg || isSending) return;

      if (!window.Clerk || !Clerk.user) {
        toast("Please sign in to use the chat");
        return;
      }

      msgEl.value = "";
      addMessage("user", msg);

      // Create assistant bubble for streaming
      const bubble = addMessage("bot", "");
      lastAssistantText = "";
      setSending(true);


      try{
        const res = await fetch(`${API_BASE}/chat`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({message: msg, conversation_id: "web"})
        });

        if (!res.ok){
          const t = await res.text().catch(()=> "");
          throw new Error(`HTTP ${res.status} ${t}`);
        }

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = "";

        while(true){
          const {value, done} = await reader.read();
          if(done) break;
          buffer += decoder.decode(value, {stream:true});

          const parts = buffer.split("\n\n");
          buffer = parts.pop();

          for(const p of parts){
            if(!p.startsWith("data: ")) continue;
            const evt = JSON.parse(p.slice(6));
            if(evt.type === "delta"){
              lastAssistantText += evt.text;
              bubble.innerHTML = marked.parse(lastAssistantText);
              chatEl.scrollTop = chatEl.scrollHeight;
            } else if(evt.type === "done"){
              // done
            }
          }
        }

        // Keep for "Copy last"
        lastAssistantText = bubble.textContent || lastAssistantText;

      } catch(err){
        bubble.textContent = "Error: " + (err?.message || String(err));
        toast("Request failed");
      } finally{
        setSending(false);
      }
    }

    sendBtn.addEventListener("click", send);

    msgEl.addEventListener("keydown", (e)=>{
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        send();
      }
    });

    clearBtn.addEventListener("click", ()=>{
      chatEl.innerHTML = "";
      lastAssistantText = "";
      toast("Cleared");
    });

    copyBtn.addEventListener("click", async ()=>{
      if(!lastAssistantText){
        toast("Nothing to copy");
        return;
      }
      try{
        await navigator.clipboard.writeText(lastAssistantText);
        toast("Copied");
      } catch {
        toast("Copy failed");
      }
    });

    // Initial welcome message
    const welcomeBubble = addMessage("bot", `
    <h3>ðŸ‘‹ Welcome to <b>Plannos</b></h3>
    <p style="margin-bottom:6px">Your intelligent planning policy assistant.</p>

    <p><b>Try one of these:</b></p>
    <ul>
      <li><a href="#" data-example="Westminster: rear extension policy?">Westminster: rear extension policy?</a></li>
      <li><a href="#" data-example="Global Policy: overheating guidance?">Global Policy: overheating guidance?</a></li>
      <li><a href="#" data-example="Compare Camden vs Global Policy: energy efficiency?">Compare Camden vs Global Policy: energy efficiency?</a></li>
    </ul>
    `, { html: true });

    welcomeBubble.classList.add("welcome");

    chatEl.addEventListener("click", (e) => {
      const a = e.target.closest("a[data-example]");
      if (!a) return;
      e.preventDefault();
      msgEl.value = a.dataset.example;
      msgEl.focus();
    });

  async function initClerk() {
    await Clerk.load();

    document.getElementById("signInBtn").onclick = () => {
      Clerk.mountSignIn(document.getElementById("signIn"));
    };

    document.getElementById("signUpBtn").onclick = () => {
      Clerk.mountSignUp(document.getElementById("signUp"));
    };

    Clerk.addListener(({ user }) => {
      const userBtn = document.getElementById("userBtn");
      userBtn.innerHTML = "";
      if (user) {
        Clerk.mountUserButton(userBtn);
      }

      if (user) {
        msgEl.disabled = false;
        sendBtn.disabled = false;
        statusText.textContent = "Ready";
      } else {
        msgEl.disabled = true;
        sendBtn.disabled = true;
        statusText.textContent = "Please sign in";
      }
    });
  }

  (function waitForClerk(){
    if (window.Clerk) {
      initClerk();
    } else {
      setTimeout(waitForClerk, 50);
    }
  })();

  </script>
</body>
</html>
